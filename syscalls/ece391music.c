#include <stdint.h>
#include "ece391support.h"
#include "ece391syscall.h"

int32_t freq_default[] = {1047, 1175, 1319, 1175, 1047};
int32_t dura_default[] = {200, 200, 200, 200, 200};
int32_t freq_nyan_cat[] = {739, 830, 0, 554, 622, 493, 0, 587, 554, 493, 0, 493, 0, 554, 587, 0, 587, 0, 554, 0, 493,
                           554, 622, 739, 830, 622, 739, 554, 587, 493, 554, 493, 622, 739, 0, 830, 622, 739, 554, 587,
                           493, 554, 622, 587, 554, 493, 554, 587, 0, 493, 554, 587, 739, 554, 587, 554, 493, 554, 0,
                           493, 0, 554, 0, 739, 830, 0, 554, 622, 493, 0, 587, 554, 493, 0, 493, 0, 554, 587, 0, 587, 0,
                           554, 0, 493, 554, 622, 739, 830, 622, 739, 554, 587, 493, 554, 493, 622, 739, 0, 830, 622,
                           739, 554, 587, 493, 554, 622, 587, 554, 493, 554, 587, 0, 493, 554, 587, 739, 554, 587, 554,
                           493, 554, 493, 0, 493, 0, 493, 0, 369, 415, 493, 0, 369, 415, 493, 554, 622, 554, 659, 622,
                           659, 739, 493, 0, 493, 0, 369, 415, 493, 415, 659, 622, 554, 493, 369, 311, 329, 369, 493, 0,
                           369, 415, 493, 0, 369, 415, 493, 493, 554, 622, 493, 369, 415, 369, 493, 493, 466, 493, 369,
                           415, 493, 659, 622, 659, 739, 493, 0, 466, 0, 493, 0, 369, 415, 493, 0, 369, 415, 493, 554,
                           622, 554, 659, 622, 659, 739, 493, 0, 493, 0, 369, 415, 493, 415, 659, 622, 554, 493, 369,
                           311, 329, 369, 493, 0, 369, 415, 493, 0, 369, 415, 493, 493, 554, 622, 493, 369, 415, 369,
                           493, 493, 466, 493, 369, 415, 493, 659, 622, 659, 739, 493, 554, 739, 830, 0, 554, 622, 493,
                           0, 587, 554, 493, 0, 493, 0, 554, 587, 0, 587, 0, 554, 0, 493, 554, 622, 739, 830, 622, 739,
                           554, 587, 493, 554, 493, 622, 739, 0, 830, 622, 739, 554, 587, 493, 554, 622, 587, 554, 493};
int32_t dura_nyan_cat[] = {428, 214, 214, 214, 428, 107, 107, 214, 214, 214, 214, 214, 214, 428, 214, 214, 107, 107,
                           107, 107, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 428, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 428, 214, 214, 214, 428, 107, 107, 214, 214,
                           214, 214, 214, 214, 428, 214, 214, 107, 107, 107, 107, 214, 214, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 428, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 428, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 428, 214, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214,
                           214, 214, 428, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 428, 428, 428, 214, 214,
                           214, 428, 107, 107, 214, 214, 214, 214, 214, 214, 428, 214, 214, 107, 107, 107, 107, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 428, 214, 214, 214, 214, 214, 214,
                           214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214, 214};

void beep(uint32_t freq, uint32_t dura) {
    int i; // loop counter
    uint8_t dum[] = "d";
    // set the rtc
    uint8_t buf[] = "rtc";
    uint32_t t = 32;
    int dev_rtc = ece391_open(buf);
    ece391_write(dev_rtc, &t, 4);
    if (dev_rtc == -1) {
        ece391_fdputs (1, (uint8_t*)"In beep(): fail to set RTC.\n");
        return;
    }
    // play the music
    ece391_play_sound(freq);
    for (i = 0; i < dura; i++) ece391_read(dev_rtc, dum, 1);
    ece391_nosound();

    ece391_close(dev_rtc);
}


int32_t ascii2num(uint8_t* buf, int32_t length){
    int i;
    int32_t ret = 0;
    int32_t pow = 1;

    if (buf == 0 || length == 0) return -1;

    for (i = 0; i < length; i++) {
        if (buf[length - i - 1] < '0' || buf[length - i - 1] > '9') return -1;
        ret += (buf[length - i - 1] - '0') * pow;
        pow *= 10;
    }

    return ret;
}


int32_t main(){
    uint8_t buf[1024]; // big enough buffer
    int i;

    if (0 != ece391_getargs(buf, 1024)) {
        ece391_fdputs (1, (uint8_t*)"Fail in reading args\n");
        return -1;
    }

    // go through blanks
    for (i = 0; i < 1024; i++){
        if (buf[i] != ' ') break;
    }

    // translate the number
    uint8_t arg_music[128];
    int32_t arg_len = 0;
    for (; i < 128; i++){
        if ( buf[i] == ' ' || buf[i] == '\0' ){
            break;
        } else {
            arg_music[arg_len++]=buf[i];
        }
    }
    uint32_t music_num = ascii2num(arg_music, arg_len);
    if (music_num == -1 || arg_len == 0){
        ece391_fdputs (1, (uint8_t*)"Format: music <number> \n");
        return -1;
    }

    // play the right music
    switch (music_num){
        case 1:
            for (i=0; i<50; i++) beep(freq_nyan_cat[i], dura_nyan_cat[i] / 48);
            break;
        case 2:
            for (i=0; i<300; i++) beep(freq_nyan_cat[i], dura_nyan_cat[i] / 48);
            break;
        default:
            for (i=0; i<5; i++) beep(freq_default[i], dura_default[i] / 32);
            break;
    }

    return 0;
}
