//
// Created by BOURNE on 2021/5/2.
//

#include "modex.h"


// ------------------------------------------Macros-------------------------------------------------

#define NUM_SEQUENCER_REGS      5
#define NUM_CRTC_REGS           25
#define NUM_GRAPHICS_REGS       9
#define NUM_ATTR_REGS           22



// ---------------------------------------Useful arrays---------------------------------------------

// The three palette for wall and player
static unsigned  char  player_palette[10][3] = {
        {0x00,0x00,0xCD},
        {0x00,0xFF,0x99},
        {0x56,0x12,0x2A},
        {0x43,0x12,0x56},
        {0x17,0x56,0x12},
        {0x12,0x53,0x56},
        {0x12,0x18,0x56},
        {0x12,0x56,0x51},
        {0x36,0x12,0x56},
        {0x1F,0x3E,0x27},
};

static unsigned  char  wall_content_palette[10][3] = {
        {0x00,0x00,0xCD},
        {0x00,0xFF,0x99},
        {0x56,0x12,0x2A},
        {0x43,0x12,0x56},
        {0x17,0x56,0x12},
        {0x12,0x53,0x56},
        {0x12,0x18,0x56},
        {0x12,0x56,0x51},
        {0x36,0x12,0x56},
        {0x1F,0x3E,0x27},
};

static unsigned  char  wall_edge_palette[10][3] = {
        {0x00,0x00,0xCD},
        {0x00,0xFF,0x99},
        {0x56,0xA2,0x2A},
        {0x49,0x12,0x56},
        {0x17,0x56,0x12},
        {0x12,0x53,0x56},
        {0x12,0x18,0x2A},
        {0x12,0x66,0x51},
        {0x00,0x12,0x56},
        {0x1F,0x3E,0x27},
};


/* VGA register settings for mode X */
static unsigned short mode_X_seq[NUM_SEQUENCER_REGS] = {
        0x0100, 0x2101, 0x0F02, 0x0003, 0x0604
};

static unsigned short mode_X_CRTC[NUM_CRTC_REGS] = {
    0x5F00, 0x4F01, 0x5002, 0x8203, 0x5404, 0x8005, 0xBF06, 0x1F07,
    0x0008, 0x4109, 0x000A, 0x000B, 0x000C, 0x000D, 0x000E, 0x000F,
    0x9C10, 0x8E11, 0x8F12, 0x2813, 0x0014, 0x9615, 0xB916, 0xE317,
    0xB618
};

/*here we need to modify MAX_SCAN_LINE(09) to 01 (bit 9 of line compare)
                         LINE_COMPARE_REGISTER(18) to 6C (182 * 2 - 1 - 256)
  Then we add a status bar (height 16 + 2) to the line 182 (200 - 18) at the bottom of screen*/

/*The reason why is 6B18 is that VGA will scan each line twice, so 182 means the 363th and 364th scan.
  we put 363 - 256 in port 18 to ensure the correct position of status bar*/
/*The reason why is 0109 is that the 9th bit of line compare field is in max scan line. We need to
  clear that bit*/
//static unsigned short mode_X_CRTC[NUM_CRTC_REGS] = {
//        0x5F00, 0x4F01, 0x5002, 0x8203, 0x5404, 0x8005, 0xBF06, 0x1F07,
//        0x0008, 0x0109, 0x000A, 0x000B, 0x000C, 0x000D, 0x000E, 0x000F,
//        0x9C10, 0x8E11, 0x8F12, 0x2813, 0x0014, 0x9615, 0xB916, 0xE317,
//        0x6B18
//};

static unsigned char mode_X_attr[NUM_ATTR_REGS * 2] = {
        0x00, 0x00, 0x01, 0x01, 0x02, 0x02, 0x03, 0x03,
        0x04, 0x04, 0x05, 0x05, 0x06, 0x06, 0x07, 0x07,
        0x08, 0x08, 0x09, 0x09, 0x0A, 0x0A, 0x0B, 0x0B,
        0x0C, 0x0C, 0x0D, 0x0D, 0x0E, 0x0E, 0x0F, 0x0F,
        0x10, 0x41, 0x11, 0x00, 0x12, 0x0F, 0x13, 0x00,
        0x14, 0x00, 0x15, 0x00
};

static unsigned short mode_X_graphics[NUM_GRAPHICS_REGS] = {
        0x0000, 0x0001, 0x0002, 0x0003, 0x0004, 0x4005, 0x0506, 0x0F07,
        0xFF08
};

/* VGA register settings for text mode 3 (color text) */
static unsigned short text_seq[NUM_SEQUENCER_REGS] = {
        0x0100, 0x2001, 0x0302, 0x0003, 0x0204
};

static unsigned short text_CRTC[NUM_CRTC_REGS] = {
        0x5F00, 0x4F01, 0x5002, 0x8203, 0x5504, 0x8105, 0xBF06, 0x1F07,
        0x0008, 0x4F09, 0x0D0A, 0x0E0B, 0x000C, 0x000D, 0x000E, 0x000F,
        0x9C10, 0x8E11, 0x8F12, 0x2813, 0x1F14, 0x9615, 0xB916, 0xA317,
        0xFF18
};
static unsigned char text_attr[NUM_ATTR_REGS * 2] = {
        0x00, 0x00, 0x01, 0x01, 0x02, 0x02, 0x03, 0x03,
        0x04, 0x04, 0x05, 0x05, 0x06, 0x06, 0x07, 0x07,
        0x08, 0x08, 0x09, 0x09, 0x0A, 0x0A, 0x0B, 0x0B,
        0x0C, 0x0C, 0x0D, 0x0D, 0x0E, 0x0E, 0x0F, 0x0F,
        0x10, 0x0C, 0x11, 0x00, 0x12, 0x0F, 0x13, 0x08,
        0x14, 0x00, 0x15, 0x00
};
static unsigned short text_graphics[NUM_GRAPHICS_REGS] = {
        0x0000, 0x0001, 0x0002, 0x0003, 0x0004, 0x1005, 0x0E06, 0x0007,
        0xFF08
};

static unsigned char original_palette[64][3] = {
        { 0x00, 0x00, 0x00 },{ 0x00, 0x00, 0x2A },   /* palette 0x00 - 0x0F    */
        { 0x00, 0x2A, 0x00 },{ 0x00, 0x2A, 0x2A },   /* basic VGA colors       */
        { 0x2A, 0x00, 0x00 },{ 0x2A, 0x00, 0x2A },
        { 0x2A, 0x15, 0x00 },{ 0x2A, 0x2A, 0x2A },
        { 0x15, 0x15, 0x15 },{ 0x15, 0x15, 0x3F },
        { 0x15, 0x3F, 0x15 },{ 0x15, 0x3F, 0x3F },
        { 0x3F, 0x15, 0x15 },{ 0x3F, 0x15, 0x3F },
        { 0x3F, 0x3F, 0x15 },{ 0x3F, 0x3F, 0x3F },
        { 0x00, 0x00, 0x00 },{ 0x05, 0x05, 0x05 },   /* palette 0x10 - 0x1F    */
        { 0x08, 0x08, 0x08 },{ 0x0B, 0x0B, 0x0B },   /* VGA grey scale         */
        { 0x0E, 0x0E, 0x0E },{ 0x11, 0x11, 0x11 },
        { 0x14, 0x14, 0x14 },{ 0x18, 0x18, 0x18 },
        { 0x1C, 0x1C, 0x1C },{ 0x20, 0x20, 0x20 },
        { 0x24, 0x24, 0x24 },{ 0x28, 0x28, 0x28 },
        { 0x2D, 0x2D, 0x2D },{ 0x32, 0x32, 0x32 },
        { 0x38, 0x38, 0x38 },{ 0x3F, 0x3F, 0x3F },
        { 0x3F, 0x3F, 0x3F },{ 0x3F, 0x3F, 0x3F },   /* palette 0x20 - 0x2F    */
        { 0x00, 0x00, 0x3F },{ 0x00, 0x00, 0x00 },   /* wall and player colors */
        { 0x00, 0x00, 0x00 },{ 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00 },{ 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00 },{ 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00 },{ 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00 },{ 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00 },{ 0x00, 0x00, 0x00 },   /* END OF WALL AND PLAYER */
        { 0x10, 0x08, 0x00 },{ 0x18, 0x0C, 0x00 },   /* palette 0x30 - 0x3F    */
        { 0x20, 0x10, 0x00 },{ 0x28, 0x14, 0x00 },   /* browns for maze floor  */
        { 0x30, 0x18, 0x00 },{ 0x38, 0x1C, 0x00 },
        { 0x3F, 0x20, 0x00 },{ 0x3F, 0x20, 0x10 },
        { 0x20, 0x18, 0x10 },{ 0x28, 0x1C, 0x10 },
        { 0x3F, 0x20, 0x10 },{ 0x38, 0x24, 0x10 },
        { 0x3F, 0x28, 0x10 },{ 0x3F, 0x2C, 0x10 },
        { 0x3F, 0x30, 0x10 },{ 0x3F, 0x20, 0x10 }
};

// -----------------------------------------------------Functions----------------------------------------------------